<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Portfolio Pulse V2</title>
<style>
:root{--bg:#0b0f14;--panel:#0f1620;--muted:#93a0b4;--text:#e8eef7;--line:rgba(255,255,255,.08);--shadow:0 10px 28px rgba(0,0,0,.35)}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:radial-gradient(900px 600px at 20% -10%,rgba(78,140,255,.12),transparent 55%),radial-gradient(900px 600px at 120% 10%,rgba(0,255,170,.10),transparent 55%),var(--bg);color:var(--text);font:14px/1.35 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
.wrap{max-width:1180px;margin:0 auto;padding:18px 16px 28px}
header{display:flex;gap:14px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;padding:10px 12px;border:1px solid var(--line);background:rgba(16,24,35,.55);backdrop-filter:blur(10px);border-radius:16px;box-shadow:var(--shadow)}
.brand{display:flex;gap:10px;align-items:center}
.pulse{width:12px;height:12px;border-radius:999px;background:#2b8cff;box-shadow:0 0 0 0 rgba(43,140,255,.65);animation:pulse 2.2s infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(43,140,255,.65)}70%{box-shadow:0 0 0 10px rgba(43,140,255,0)}100%{box-shadow:0 0 0 0 rgba(43,140,255,0)}}
.h1{font-size:18px;font-weight:750;letter-spacing:.2px}
.sub{color:var(--muted);font-size:12px;margin-top:2px}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
.btn{appearance:none;border:1px solid var(--line);background:rgba(17,25,38,.7);color:var(--text);padding:8px 10px;border-radius:12px;cursor:pointer;transition:transform .12s ease,background .12s ease,border-color .12s ease}
.btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.16)}
.btn:active{transform:translateY(0)}
.sel{border:1px solid var(--line);background:rgba(17,25,38,.7);color:var(--text);padding:8px 10px;border-radius:12px}
.pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);border-radius:999px;padding:7px 10px;background:rgba(17,25,38,.55);color:var(--muted);font-size:12px}
.dot{width:8px;height:8px;border-radius:999px;background:#64748b}
.dot.ok{background:#22c55e}.dot.warn{background:#f59e0b}.dot.bad{background:#ef4444}
.row{display:grid;grid-template-columns:1.3fr .7fr;gap:12px;margin-top:12px}
@media(max-width:900px){.row{grid-template-columns:1fr}}
.widgets{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
@media(max-width:640px){.widgets{grid-template-columns:1fr}}
.widget{border:1px solid var(--line);background:rgba(16,24,35,.45);border-radius:14px;padding:10px 12px;box-shadow:var(--shadow)}
.widget .k{color:var(--muted);font-size:12px}
.widget .v{font-size:18px;font-weight:800;margin-top:2px}
.widget .s{color:var(--muted);font-size:12px;margin-top:2px}
.summary{border:1px solid var(--line);background:rgba(16,24,35,.45);border-radius:14px;padding:10px 12px;box-shadow:var(--shadow);display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.summary b{font-weight:800}
.small{color:var(--muted);font-size:12px}
.progress{margin-top:10px;padding:8px 10px;background:rgba(16,24,35,.45);border:1px solid var(--line);border-radius:10px;font-size:12px;color:var(--muted)}
.progress-bar{margin-top:4px;height:4px;background:rgba(255,255,255,.1);border-radius:2px;overflow:hidden}
.progress-fill{height:100%;background:#2b8cff;border-radius:2px;width:0%;transition:width .3s ease}
.sector{margin-top:20px}.sector:first-child{margin-top:12px}
.sector-header{color:var(--muted);font-size:13px;font-weight:600;margin-bottom:10px;padding-left:2px;letter-spacing:.3px;text-transform:uppercase}
.grid{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px}
@media(max-width:1100px){.grid{grid-template-columns:repeat(5,minmax(0,1fr))}}
@media(max-width:900px){.grid{grid-template-columns:repeat(4,minmax(0,1fr))}}
@media(max-width:700px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
@media(max-width:520px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
.card{position:relative;border-radius:14px;padding:10px 10px 8px;border:1px solid rgba(255,255,255,.10);box-shadow:0 10px 22px rgba(0,0,0,.28);transition:transform .13s ease,filter .13s ease,border-color .13s ease;min-height:98px;overflow:hidden;opacity:0;transform:translateY(6px);animation:in .28s ease forwards;cursor:pointer}
@keyframes in{to{opacity:1;transform:translateY(0)}}
.card:hover{transform:translateY(-2px);filter:saturate(1.06);border-color:rgba(255,255,255,.18)}
.card.expanded{border-color:#2b8cff;z-index:10}
.sym{font-size:16px;font-weight:900;letter-spacing:.5px}
.price{margin-top:2px;font-size:14px;font-weight:750}
.delta{margin-top:2px;font-size:12px;color:rgba(255,255,255,.86)}
.delta .muted{color:rgba(255,255,255,.72)}
.tag{position:absolute;top:8px;right:8px;font-size:11px;color:rgba(255,255,255,.85);border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.16);padding:3px 7px;border-radius:999px}
.tag.stale{border-color:rgba(245,158,11,.35);color:rgba(245,158,11,.95)}
.spark{margin-top:6px;height:22px;opacity:.95}
.spark svg{width:100%;height:22px;display:block}
.spark polyline{fill:none;stroke:rgba(255,255,255,.82);stroke-width:1.6;stroke-linecap:round;stroke-linejoin:round}
.card.muted{filter:saturate(.2) brightness(.95)}
.detail{display:none;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,.1);font-size:12px;color:var(--muted)}
.detail.show{display:block}
.detail-row{display:flex;justify-content:space-between;margin-bottom:3px}
.notice{margin-top:10px;color:var(--muted);font-size:12px}
kbd{font:12px ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;color:#d5deea;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.10);padding:2px 6px;border-radius:8px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="pulse" aria-hidden="true"></div>
      <div>
        <div class="h1">Portfolio Pulse V2</div>
        <div class="sub"><span id="now">â€”</span> Â· Last refresh: <span id="last">â€”</span></div>
      </div>
    </div>
    <div class="controls">
      <span class="pill"><span id="statusDot" class="dot"></span><span id="statusText">Idle</span></span>
      <select id="sort" class="sel" title="Sort">
        <option value="alpha">Sort: Aâ†’Z</option>
        <option value="best">Sort: % best</option>
        <option value="worst">Sort: % worst</option>
      </select>
      <label class="pill" title="Auto-refresh every 5 minutes"><input id="auto" type="checkbox" style="accent-color:#2b8cff"> Auto (5m)</label>
      <button id="refresh" class="btn">Refresh</button>
    </div>
  </header>
  <div class="progress" id="progress" style="display:none">
    <div id="progressText">Starting...</div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  </div>
  <div class="row">
    <div class="summary">
      <div>
        <div><b id="mood">â€”</b> <span class="small">Â· <span id="counts">â€”</span></span></div>
        <div class="small">Best: <span id="best">â€”</span> Â· Worst: <span id="worst">â€”</span></div>
      </div>
      <button id="copy" class="btn" title="Copy snapshot">Copy snapshot</button>
    </div>
    <div class="widgets">
      <div class="widget" id="fngW"><div class="k">Fear &amp; Greed</div><div class="v" id="fngV">â€”</div><div class="s" id="fngS">â€”</div></div>
      <div class="widget" id="goldW"><div class="k">Gold (XAU/USD)</div><div class="v" id="goldV">â€”</div><div class="s" id="goldS">â€”</div></div>
      <div class="widget" id="silverW"><div class="k">Silver (XAG/USD)</div><div class="v" id="silverV">â€”</div><div class="s" id="silverS">â€”</div></div>
    </div>
  </div>
  <div id="sectors"></div>
  <div class="notice">Click any card for details Â· <kbd>R</kbd> refresh Â· <kbd>C</kbd> copy snapshot</div>
</div>
<script>
const AV_KEY = new URLSearchParams(location.search).get('key')
  || new URLSearchParams(location.search).get('av_key')
  || '12MUDMVP4BGMRBQA';

const SECTORS = {
  'Tech':['AAPL','MSFT','NVDA','GOOGL','AMZN','META'],
  'Trading / Finance':['HOOD','SPY','QQQ'],
  'Energy / AI Infra':['OKLO','IREN','NBIS','PLTR'],
  'Healthcare':['OSCR','MOH'],
  'Speculative':['TSLA','MSTR','RKLB'],
  'Crypto':['BTC','ETH','SOL']
};
const ALL_STOCKS = Object.values(SECTORS).flat().filter(s=>!['BTC','ETH','SOL'].includes(s));
const CRYPTO_MAP = {BTC:'bitcoin',ETH:'ethereum',SOL:'solana'};
const CACHE_KEY = 'portfolio_pulse_v2';
const CACHE_TTL = 5*60*1000; // 5 min

const state = {stocks:{},cryptos:{},widgets:{fng:{},gold:{},silver:{}},expanded:null};

/* â”€â”€ Cache â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function saveCache(){
  try{localStorage.setItem(CACHE_KEY,JSON.stringify({ts:Date.now(),stocks:state.stocks,cryptos:state.cryptos,widgets:state.widgets}))}catch(e){}
}
function loadCache(){
  try{
    const raw=localStorage.getItem(CACHE_KEY);
    if(!raw)return false;
    const c=JSON.parse(raw);
    if(Date.now()-c.ts>30*60*1000)return false; // stale >30 min
    Object.assign(state.stocks,c.stocks||{});
    Object.assign(state.cryptos,c.cryptos||{});
    Object.assign(state.widgets,c.widgets||{});
    return true;
  }catch(e){return false}
}

/* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
async function fetchJSON(url){const r=await fetch(url);if(!r.ok)throw new Error(`HTTP ${r.status}`);return r.json()}
function setStatus(t,c='ok'){document.getElementById('statusText').textContent=t;document.getElementById('statusDot').className='dot '+c}
function showProgress(text,cur,total){
  const p=document.getElementById('progress'),f=document.getElementById('progressFill'),t=document.getElementById('progressText');
  if(!total){p.style.display='none';return}
  p.style.display='block';t.textContent=text;f.style.width=`${(cur/total)*100}%`;
}

function fmt(price,prefix='$'){
  if(price==null||isNaN(price))return 'â€”';
  if(Math.abs(price)>=1e6)return prefix+(price/1e6).toFixed(1)+'M';
  if(Math.abs(price)>=1e3)return prefix+price.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  if(Math.abs(price)<1)return prefix+price.toFixed(4);
  return prefix+price.toFixed(2);
}
function fmtCap(c){if(!c)return'â€”';if(c>=1e12)return'$'+(c/1e12).toFixed(1)+'T';if(c>=1e9)return'$'+(c/1e9).toFixed(1)+'B';if(c>=1e6)return'$'+(c/1e6).toFixed(1)+'M';return'$'+(c/1e3).toFixed(0)+'K'}
function cardBg(pct){
  if(pct>0){const i=Math.min(pct/5,1)*.15;return`linear-gradient(135deg,rgba(34,197,94,${i}),rgba(16,24,35,.65))`}
  if(pct<0){const i=Math.min(Math.abs(pct)/5,1)*.15;return`linear-gradient(135deg,rgba(239,68,68,${i}),rgba(16,24,35,.65))`}
  return'rgba(16,24,35,.65)';
}
function sparkSvg(prices){
  if(!prices||prices.length<2)return'';
  const mn=Math.min(...prices),mx=Math.max(...prices),rng=mx-mn,W=100,H=20;
  if(rng===0)return`<svg viewBox="0 0 ${W} ${H}"><polyline points="${prices.map((_,i)=>`${i/(prices.length-1)*W},${H/2}`).join(' ')}"/></svg>`;
  const pts=prices.map((p,i)=>`${i/(prices.length-1)*W},${H-(p-mn)/rng*H}`).join(' ');
  return`<svg viewBox="0 0 ${W} ${H}"><polyline points="${pts}"/></svg>`;
}

/* â”€â”€ API Fetchers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function avFetch(fn,params){
  const url=`https://www.alphavantage.co/query?function=${fn}&${params}&apikey=${AV_KEY}`;
  const j=await fetchJSON(url);
  if(j['Note']||j['Information'])throw new Error('Rate limited');
  if(j['Error Message'])throw new Error('Invalid');
  return j;
}

async function fetchStock(sym){
  try{
    const j=await avFetch('GLOBAL_QUOTE',`symbol=${sym}`);
    const q=j['Global Quote'];if(!q||!q['05. price'])throw new Error('No data');
    return{price:+q['05. price'],change:+q['09. change'],pct:parseFloat(q['10. change percent']),
      high:+q['03. high']||null,low:+q['04. low']||null,volume:q['06. volume']||null,
      prevClose:+q['08. previous close']||null,ts:Date.now()};
  }catch(e){return{error:e.message}}
}

async function fetchMetal(from,to){
  try{
    const j=await avFetch('FX_DAILY',`from_symbol=${from}&to_symbol=${to}`);
    const s=j['Time Series (FX Daily)'];if(!s)throw new Error('No data');
    const keys=Object.keys(s);const p=+s[keys[0]]['4. close'],pp=+s[keys[1]]['4. close'];
    return{price:p,change:p-pp,pct:(p-pp)/pp*100,ts:Date.now()};
  }catch(e){return{error:e.message}}
}

async function fetchCryptos(){
  try{
    const ids=Object.values(CRYPTO_MAP).join(',');
    const j=await fetchJSON(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd&include_24hr_change=true&include_market_cap=true`);
    for(const[sym,id]of Object.entries(CRYPTO_MAP)){
      const d=j[id];
      if(!d)continue;
      state.cryptos[sym]={price:d.usd,pct:d.usd_24h_change,change:d.usd*(d.usd_24h_change/100),marketCap:d.usd_market_cap,ts:Date.now()};
    }
  }catch(e){console.warn('CoinGecko prices failed',e)}
  // sparklines â€” one call, different endpoint
  try{
    for(const[sym,id]of Object.entries(CRYPTO_MAP)){
      try{
        const s=await fetchJSON(`https://api.coingecko.com/api/v3/coins/${id}/market_chart?vs_currency=usd&days=7&interval=daily`);
        if(state.cryptos[sym])state.cryptos[sym].sparkline=s.prices?.slice(-5)?.map(p=>p[1])||[];
      }catch(e){}
      await sleep(1500); // gentle CoinGecko spacing
    }
  }catch(e){}
}

async function fetchFNG(){
  try{
    const j=await fetchJSON('https://api.alternative.me/fng/?limit=1&format=json');
    const d=j?.data?.[0];const v=d?Number(d.value):null;const label=d?.value_classification||'â€”';
    let color='rgba(255,255,255,.14)';
    if(/Extreme Fear/i.test(label))color='rgba(239,68,68,.45)';
    else if(/^Fear/i.test(label))color='rgba(245,158,11,.45)';
    else if(/Neutral/i.test(label))color='rgba(148,163,184,.35)';
    else if(/^Greed/i.test(label))color='rgba(34,197,94,.45)';
    else if(/Extreme Greed/i.test(label))color='rgba(34,197,94,.55)';
    state.widgets.fng={value:isFinite(v)?v:null,label,color};
  }catch(e){state.widgets.fng={value:null,label:'Unavailable'}}
}

/* â”€â”€ Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderCard(sym){
  const isCrypto=!!CRYPTO_MAP[sym];
  const d=isCrypto?state.cryptos[sym]:state.stocks[sym];
  if(!d)return`<div class="card muted"><div class="sym">${sym}</div><div class="price" style="color:var(--muted)">Loadingâ€¦</div></div>`;
  if(d.error)return`<div class="card muted"><div class="sym">${sym}</div><div class="price" style="color:var(--muted)">â€”</div><div class="delta"><span class="muted">${d.error}</span></div></div>`;
  const pc=d.pct>=0?'#22c55e':'#ef4444';const pfx=d.pct>=0?'+':'';
  const spark=d.sparkline?sparkSvg(d.sparkline):'';
  const stale=d.ts&&(Date.now()-d.ts>CACHE_TTL)?'<span class="tag stale">cached</span>':'';
  return`<div class="card" style="background:${cardBg(d.pct)}" data-sym="${sym}" data-type="${isCrypto?'crypto':'stock'}">
    ${stale}<div class="sym">${sym}</div>
    <div class="price">${fmt(d.price)}</div>
    <div class="delta" style="color:${pc}">${pfx}${d.pct?.toFixed(2)}%</div>
    ${spark?`<div class="spark">${spark}</div>`:''}
    <div class="detail" id="det-${sym}"></div></div>`;
}

function renderSectors(){
  const c=document.getElementById('sectors');c.innerHTML='';
  for(const[name,syms]of Object.entries(SECTORS)){
    const sec=document.createElement('div');sec.className='sector';
    const hdr=document.createElement('div');hdr.className='sector-header';hdr.textContent=name;
    const grid=document.createElement('div');grid.className='grid';
    syms.forEach(s=>grid.innerHTML+=renderCard(s));
    sec.append(hdr,grid);c.appendChild(sec);
  }
  attachCardClicks();
}

function attachCardClicks(){
  document.querySelectorAll('.card[data-sym]').forEach(card=>{
    card.onclick=e=>{
      e.stopPropagation();
      const sym=card.dataset.sym,type=card.dataset.type;
      if(state.expanded===sym){card.classList.remove('expanded');const det=document.getElementById('det-'+sym);if(det)det.classList.remove('show');state.expanded=null;return}
      // collapse prev
      if(state.expanded){const p=document.querySelector(`[data-sym="${state.expanded}"]`);if(p)p.classList.remove('expanded');const pd=document.getElementById('det-'+state.expanded);if(pd)pd.classList.remove('show')}
      card.classList.add('expanded');state.expanded=sym;
      const d=type==='crypto'?state.cryptos[sym]:state.stocks[sym];
      const det=document.getElementById('det-'+sym);if(!det||!d||d.error)return;
      if(type==='stock'){
        det.innerHTML=`<div class="detail-row"><span>Day High:</span><span>${d.high?fmt(d.high):'â€”'}</span></div>
          <div class="detail-row"><span>Day Low:</span><span>${d.low?fmt(d.low):'â€”'}</span></div>
          <div class="detail-row"><span>Volume:</span><span>${d.volume?Number(d.volume).toLocaleString():'â€”'}</span></div>
          <div class="detail-row"><span>Prev Close:</span><span>${d.prevClose?fmt(d.prevClose):'â€”'}</span></div>`;
      }else{
        det.innerHTML=`<div class="detail-row"><span>Market Cap:</span><span>${fmtCap(d.marketCap)}</span></div>`;
      }
      det.classList.add('show');
    };
  });
}

function updateWidgets(){
  const{fng,gold,silver}=state.widgets;
  document.getElementById('fngV').textContent=fng.value!=null?fng.value:'â€”';
  document.getElementById('fngS').textContent=fng.label||'â€”';
  if(fng.color)document.getElementById('fngW').style.background=fng.color;
  for(const[key,data]of[['gold',gold],['silver',silver]]){
    const vEl=document.getElementById(key+'V'),sEl=document.getElementById(key+'S'),wEl=document.getElementById(key+'W');
    if(data?.price){vEl.textContent=fmt(data.price);const pc=data.pct>=0?'#22c55e':'#ef4444';const pfx=data.pct>=0?'+':'';sEl.innerHTML=`<span style="color:${pc}">${pfx}${data.pct.toFixed(2)}%</span>`;wEl.style.background=cardBg(data.pct)}
    else if(data?.error){vEl.textContent='â€”';sEl.textContent='Loadingâ€¦'}
    else{vEl.textContent='â€”';sEl.textContent='Pending'}
  }
}

function updateSummary(){
  const all=[...Object.entries(state.stocks),...Object.entries(state.cryptos)];
  const valid=all.filter(([_,d])=>d?.price&&!d.error);
  if(!valid.length)return;
  const pos=valid.filter(([_,d])=>d.pct>0).length,neg=valid.filter(([_,d])=>d.pct<0).length;
  let mood='ðŸ“Š Mixed';if(pos>neg*1.5)mood='ðŸŸ¢ Bullish';else if(neg>pos*1.5)mood='ðŸ”´ Bearish';
  document.getElementById('mood').textContent=mood;
  document.getElementById('counts').textContent=`${pos}â†— ${neg}â†˜ ${valid.length-pos-neg}â†’`;
  const sorted=[...valid].sort((a,b)=>b[1].pct-a[1].pct);
  document.getElementById('best').textContent=sorted[0]?`${sorted[0][0]} +${sorted[0][1].pct.toFixed(2)}%`:'â€”';
  const w=sorted[sorted.length-1];document.getElementById('worst').textContent=w?`${w[0]} ${w[1].pct.toFixed(2)}%`:'â€”';
}

/* â”€â”€ Main Refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function refresh(){
  setStatus('Loadingâ€¦','warn');
  showProgress('Startingâ€¦',0,1);

  // Phase 0: Non-rate-limited APIs in parallel
  await Promise.all([fetchFNG(), fetchCryptos()]);
  updateWidgets();renderSectors();updateSummary();

  // Phase 1: Stock quotes (AV, 5/min)
  let done = 0;
  const batchSize = 4; // conservative: 4/min leaves headroom
  const failed = [];

  for(let i=0;i<ALL_STOCKS.length;i+=batchSize){
    if(i>0) await sleep(15000); // 15s for safety
    const batch=ALL_STOCKS.slice(i,i+batchSize);
    await Promise.all(batch.map(async sym=>{
      const d=await fetchStock(sym);
      if(!d.error) state.stocks[sym]=d;
      else { failed.push(sym); if(!state.stocks[sym]) state.stocks[sym]=d; }
      done++;
      showProgress(`Stocks: ${done}/${ALL_STOCKS.length}${failed.length?' Â· '+failed.length+' retrying':''}`,done,ALL_STOCKS.length+2);
    }));
    renderSectors();updateSummary();saveCache();
  }

  // Retry failed stocks
  if(failed.length){
    await sleep(15000);
    showProgress(`Retrying ${failed.length} failedâ€¦`,done,ALL_STOCKS.length+2);
    for(let i=0;i<failed.length;i+=batchSize){
      if(i>0) await sleep(15000);
      const batch=failed.slice(i,i+batchSize);
      await Promise.all(batch.map(async sym=>{
        const d=await fetchStock(sym);
        if(!d.error) state.stocks[sym]=d;
      }));
      renderSectors();updateSummary();saveCache();
    }
  }

  // Metals last (2 more AV calls)
  await sleep(15000);
  showProgress(`Loading Goldâ€¦`,ALL_STOCKS.length,ALL_STOCKS.length+2);
  const gold=await fetchMetal('XAU','USD');
  if(!gold.error)state.widgets.gold=gold;
  updateWidgets();

  await sleep(15000);
  showProgress(`Loading Silverâ€¦`,ALL_STOCKS.length+1,ALL_STOCKS.length+2);
  const silver=await fetchMetal('XAG','USD');
  if(!silver.error)state.widgets.silver=silver;
  updateWidgets();
  showProgress(`Done`,ALL_STOCKS.length+2,ALL_STOCKS.length+2);

  saveCache();
  setStatus('Complete','ok');
  document.getElementById('last').textContent=new Date().toLocaleTimeString();
  setTimeout(()=>showProgress('',0,0),1000);
}

/* â”€â”€ Copy Snapshot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function copySnapshot(){
  const lines=[`Portfolio Pulse â€” ${new Date().toLocaleString()}`,''];
  for(const[name,syms]of Object.entries(SECTORS)){
    const items=syms.map(s=>[s,state.stocks[s]||state.cryptos[s]]).filter(([_,d])=>d?.price&&!d.error);
    if(!items.length)continue;
    lines.push(name+':');
    items.forEach(([s,d])=>{const pfx=d.pct>=0?'+':'';lines.push(`  ${s}: ${fmt(d.price)} (${pfx}${d.pct.toFixed(2)}%)`)});
    lines.push('');
  }
  const{fng,gold,silver}=state.widgets;
  if(fng.value!=null)lines.push(`Fear & Greed: ${fng.value} (${fng.label})`);
  if(gold?.price)lines.push(`Gold: ${fmt(gold.price)} (${gold.pct>=0?'+':''}${gold.pct.toFixed(2)}%)`);
  if(silver?.price)lines.push(`Silver: ${fmt(silver.price)} (${silver.pct>=0?'+':''}${silver.pct.toFixed(2)}%)`);
  navigator.clipboard.writeText(lines.join('\n'));
  setStatus('Copied!','ok');setTimeout(()=>setStatus('Complete','ok'),1500);
}

/* â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.getElementById('refresh').onclick=refresh;
document.getElementById('copy').onclick=copySnapshot;
document.addEventListener('click',e=>{if(state.expanded&&!e.target.closest('.card')){const c=document.querySelector(`[data-sym="${state.expanded}"]`);if(c)c.classList.remove('expanded');const d=document.getElementById('det-'+state.expanded);if(d)d.classList.remove('show');state.expanded=null}});
document.addEventListener('keydown',e=>{if(e.target.tagName==='INPUT')return;if(e.key==='r'||e.key==='R'){e.preventDefault();refresh()}if(e.key==='c'||e.key==='C'){e.preventDefault();copySnapshot()}});
let autoIv=null;document.getElementById('auto').onchange=e=>{if(e.target.checked)autoIv=setInterval(refresh,5*60*1000);else{clearInterval(autoIv);autoIv=null}};
function tick(){document.getElementById('now').textContent=new Date().toLocaleString()}tick();setInterval(tick,1000);

/* â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const hadCache=loadCache();
if(hadCache){renderSectors();updateWidgets();updateSummary();setStatus('Cached','warn');document.getElementById('last').textContent='cached'}
refresh();
</script>
</body>
</html>