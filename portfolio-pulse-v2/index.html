<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Portfolio Pulse V2</title>
<style>
:root{--bg:#0b0f14;--panel:#0f1620;--muted:#93a0b4;--text:#e8eef7;--line:rgba(255,255,255,.08);--shadow:0 10px 28px rgba(0,0,0,.35)}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:radial-gradient(900px 600px at 20% -10%,rgba(78,140,255,.12),transparent 55%),radial-gradient(900px 600px at 120% 10%,rgba(0,255,170,.10),transparent 55%),var(--bg);color:var(--text);font:14px/1.35 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
.wrap{max-width:1180px;margin:0 auto;padding:18px 16px 28px}
header{display:flex;gap:14px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;padding:10px 12px;border:1px solid var(--line);background:rgba(16,24,35,.55);backdrop-filter:blur(10px);border-radius:16px;box-shadow:var(--shadow)}
.brand{display:flex;gap:10px;align-items:center}
.pulse{width:12px;height:12px;border-radius:999px;background:#2b8cff;box-shadow:0 0 0 0 rgba(43,140,255,.65);animation:pulse 2.2s infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(43,140,255,.65)}70%{box-shadow:0 0 0 10px rgba(43,140,255,0)}100%{box-shadow:0 0 0 0 rgba(43,140,255,0)}}
.h1{font-size:18px;font-weight:750;letter-spacing:.2px}
.sub{color:var(--muted);font-size:12px;margin-top:2px}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
.btn{appearance:none;border:1px solid var(--line);background:rgba(17,25,38,.7);color:var(--text);padding:8px 10px;border-radius:12px;cursor:pointer;transition:transform .12s ease,background .12s ease,border-color .12s ease}
.btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.16)}
.btn:active{transform:translateY(0)}
.sel{border:1px solid var(--line);background:rgba(17,25,38,.7);color:var(--text);padding:8px 10px;border-radius:12px}
.pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);border-radius:999px;padding:7px 10px;background:rgba(17,25,38,.55);color:var(--muted);font-size:12px}
.dot{width:8px;height:8px;border-radius:999px;background:#64748b}
.dot.ok{background:#22c55e}.dot.warn{background:#f59e0b}.dot.bad{background:#ef4444}
.row{display:grid;grid-template-columns:1.3fr .7fr;gap:12px;margin-top:12px}
@media (max-width:900px){.row{grid-template-columns:1fr}}
.widgets{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
@media (max-width:640px){.widgets{grid-template-columns:1fr}}
.widget{border:1px solid var(--line);background:rgba(16,24,35,.45);border-radius:14px;padding:10px 12px;box-shadow:var(--shadow)}
.widget .k{color:var(--muted);font-size:12px}
.widget .v{font-size:18px;font-weight:800;margin-top:2px}
.widget .s{color:var(--muted);font-size:12px;margin-top:2px}
.summary{border:1px solid var(--line);background:rgba(16,24,35,.45);border-radius:14px;padding:10px 12px;box-shadow:var(--shadow);display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.summary b{font-weight:800}
.small{color:var(--muted);font-size:12px}

.progress{margin-top:10px;padding:8px;background:rgba(16,24,35,.45);border:1px solid var(--line);border-radius:10px;font-size:12px;color:var(--muted)}
.progress-bar{margin-top:4px;height:4px;background:rgba(255,255,255,.1);border-radius:2px;overflow:hidden}
.progress-fill{height:100%;background:#2b8cff;border-radius:2px;width:0%;transition:width .3s ease}

.sector{margin-top:20px}
.sector:first-child{margin-top:12px}
.sector-header{color:var(--muted);font-size:13px;font-weight:600;margin-bottom:10px;padding-left:2px;letter-spacing:.3px;text-transform:uppercase}
.grid{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px}
@media (max-width:1100px){.grid{grid-template-columns:repeat(5,minmax(0,1fr))}}
@media (max-width:900px){.grid{grid-template-columns:repeat(4,minmax(0,1fr))}}
@media (max-width:700px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
@media (max-width:520px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}

.card{position:relative;border-radius:14px;padding:10px 10px 8px;border:1px solid rgba(255,255,255,.10);box-shadow:0 10px 22px rgba(0,0,0,.28);transition:transform .13s ease,filter .13s ease,border-color .13s ease;min-height:98px;overflow:hidden;opacity:0;transform:translateY(6px);animation:in .28s ease forwards;cursor:pointer}
@keyframes in{to{opacity:1;transform:translateY(0)}}
.card:hover{transform:translateY(-2px);filter:saturate(1.06);border-color:rgba(255,255,255,.18)}
.card.expanded{border-color:#2b8cff;transform:scale(1.02);z-index:10}
.sym{font-size:16px;font-weight:900;letter-spacing:.5px}
.price{margin-top:2px;font-size:14px;font-weight:750}
.delta{margin-top:2px;font-size:12px;color:rgba(255,255,255,.86)}
.delta .muted{color:rgba(255,255,255,.72)}
.tag{position:absolute;top:8px;right:8px;font-size:11px;color:rgba(255,255,255,.85);border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.16);padding:3px 7px;border-radius:999px}
.tag.stale{border-color:rgba(245,158,11,.35);color:rgba(245,158,11,.95)}
.spark{margin-top:6px;height:22px;opacity:.95}
.spark svg{width:100%;height:22px;display:block}
.spark polyline{fill:none;stroke:rgba(255,255,255,.82);stroke-width:1.6;stroke-linecap:round;stroke-linejoin:round}
.card.muted{filter:saturate(.2) brightness(.95)}

.detail{display:none;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,.1);font-size:12px;color:var(--muted)}
.detail.show{display:block}
.detail-row{display:flex;justify-content:space-between;margin-bottom:4px}
.detail-row:last-child{margin-bottom:0}

.overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:20;display:none;align-items:center;justify-content:center;padding:20px}
.overlay.show{display:flex}
.modal{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:20px;max-width:400px;width:100%;box-shadow:var(--shadow)}
.modal-header{font-size:18px;font-weight:700;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center}
.modal-close{background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;padding:0}

.notice{margin-top:10px;color:var(--muted);font-size:12px}
kbd{font:12px ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;color:#d5deea;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.10);padding:2px 6px;border-radius:8px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="pulse" aria-hidden="true"></div>
      <div>
        <div class="h1">Portfolio Pulse V2</div>
        <div class="sub"><span id="now">â€”</span> Â· Last refresh: <span id="last">â€”</span></div>
      </div>
    </div>
    <div class="controls">
      <span class="pill"><span id="statusDot" class="dot"></span><span id="statusText">Idle</span></span>
      <select id="sort" class="sel" title="Sort">
        <option value="alpha">Sort: Aâ†’Z</option>
        <option value="best">Sort: % best</option>
        <option value="worst">Sort: % worst</option>
      </select>
      <label class="pill" title="Auto-refresh every 5 minutes"><input id="auto" type="checkbox" style="accent-color:#2b8cff"> Auto (5m)</label>
      <button id="refresh" class="btn">Refresh</button>
    </div>
  </header>

  <div class="progress" id="progress" style="display:none">
    <div>Loading: <span id="progressText">Starting...</span></div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  </div>

  <div class="row">
    <div class="summary">
      <div>
        <div><b id="mood">â€”</b> <span class="small">Â· <span id="counts">â€”</span></span></div>
        <div class="small">Best: <span id="best">â€”</span> Â· Worst: <span id="worst">â€”</span></div>
      </div>
      <button id="copy" class="btn" title="Copy snapshot">Copy snapshot</button>
    </div>
    <div class="widgets">
      <div class="widget" id="fngW">
        <div class="k">Fear &amp; Greed</div>
        <div class="v" id="fngV">â€”</div>
        <div class="s" id="fngS">â€”</div>
      </div>
      <div class="widget" id="goldW">
        <div class="k">Gold (XAU/USD)</div>
        <div class="v" id="goldV">â€”</div>
        <div class="s" id="goldS">â€”</div>
      </div>
      <div class="widget" id="silverW">
        <div class="k">Silver (XAG/USD)</div>
        <div class="v" id="silverV">â€”</div>
        <div class="s" id="silverS">â€”</div>
      </div>
    </div>
  </div>

  <div id="sectors"></div>

  <div class="notice">
    Click any card for details Â· <kbd>R</kbd> refresh Â· <kbd>C</kbd> copy snapshot
  </div>
</div>

<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modal-header">
      <span id="modalTitle">Details</span>
      <button class="modal-close" id="modalClose">Ã—</button>
    </div>
    <div id="modalContent"></div>
  </div>
</div>

<script>
const HARDCODED_AV_KEY = '12MUDMVP4BGMRBQA';

const state = {
  stocks: {},
  cryptos: {},
  widgets: { fng: {}, gold: {}, silver: {} },
  expanded: null,
  loading: { quotes: 0, sparklines: 0, total: 0 }
};

const SECTORS = {
  'Tech': ['AAPL', 'MSFT', 'NVDA', 'GOOGL', 'AMZN', 'META'],
  'Trading/Finance': ['HOOD', 'SPY', 'QQQ'],
  'Energy/AI Infra': ['OKLO', 'IREN', 'NBIS', 'PLTR'],
  'Healthcare': ['OSCR', 'MOH'],
  'Speculative': ['TSLA', 'MSTR', 'RKLB'],
  'Crypto': ['BTC', 'ETH', 'SOL']
};

const ALL_STOCKS = Object.values(SECTORS).flat().filter(s => !['BTC', 'ETH', 'SOL'].includes(s));
const CRYPTOS = ['BTC', 'ETH', 'SOL'];

function getAvKey() {
  const params = new URLSearchParams(location.search);
  return params.get('key') || params.get('av_key') || HARDCODED_AV_KEY;
}

function updateProgress(text, current, total) {
  const prog = document.getElementById('progress');
  const fill = document.getElementById('progressFill');
  const textEl = document.getElementById('progressText');
  
  if (current === 0 && total === 0) {
    prog.style.display = 'none';
    return;
  }
  
  prog.style.display = 'block';
  textEl.textContent = text;
  fill.style.width = total > 0 ? `${(current / total) * 100}%` : '0%';
  
  if (current >= total) {
    setTimeout(() => prog.style.display = 'none', 1000);
  }
}

function setStatus(text, type = 'ok') {
  document.getElementById('statusText').textContent = text;
  document.getElementById('statusDot').className = `dot ${type}`;
}

async function fetchJSON(url) {
  const response = await fetch(url);
  if (!response.ok) throw new Error(`HTTP ${response.status}`);
  return response.json();
}

async function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function fetchFNG() {
  try {
    const j = await fetchJSON("https://api.alternative.me/fng/?limit=1&format=json");
    const d = j?.data?.[0];
    const value = d ? Number(d.value) : null;
    const cls = d?.value_classification || "";
    const label = cls || "â€”";
    let color = "rgba(255,255,255,.14)";
    if (/Extreme Fear/i.test(label)) color = "rgba(239,68,68,.45)";
    else if (/^Fear/i.test(label)) color = "rgba(245,158,11,.45)";
    else if (/Neutral/i.test(label)) color = "rgba(148,163,184,.35)";
    else if (/^Greed/i.test(label)) color = "rgba(34,197,94,.45)";
    else if (/Extreme Greed/i.test(label)) color = "rgba(34,197,94,.55)";
    state.widgets.fng = { value: isFinite(value) ? value : null, label, color };
  } catch (e) {
    state.widgets.fng = { value: null, label: "Unavailable" };
  }
}

async function fetchMetal(from, to) {
  const key = getAvKey();
  try {
    const url = `https://www.alphavantage.co/query?function=FX_DAILY&from_symbol=${from}&to_symbol=${to}&apikey=${key}`;
    const j = await fetchJSON(url);
    
    if (j["Error Message"] || j["Note"]) {
      throw new Error("Rate limited or invalid");
    }
    
    const series = j["Time Series (FX Daily)"];
    if (!series) throw new Error("No data");
    
    const latest = Object.keys(series)[0];
    const data = series[latest];
    const price = parseFloat(data["4. close"]);
    const prev = Object.values(series)[1];
    const prevPrice = prev ? parseFloat(prev["4. close"]) : price;
    const change = price - prevPrice;
    const pct = ((change / prevPrice) * 100);
    
    return {
      price,
      change,
      pct,
      updated: new Date().toISOString()
    };
  } catch (e) {
    return { error: e.message };
  }
}

async function fetchStock(symbol) {
  const key = getAvKey();
  try {
    const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${key}`;
    const j = await fetchJSON(url);
    
    if (j["Error Message"] || j["Note"]) {
      throw new Error("Rate limited");
    }
    
    const quote = j["Global Quote"];
    if (!quote) throw new Error("No data");
    
    const price = parseFloat(quote["05. price"]);
    const change = parseFloat(quote["09. change"]);
    const pct = parseFloat(quote["10. change percent"].replace('%', ''));
    
    return {
      price,
      change,
      pct,
      high: parseFloat(quote["03. high"]) || null,
      low: parseFloat(quote["04. low"]) || null,
      volume: quote["06. volume"] || null,
      prevClose: parseFloat(quote["08. previous close"]) || null,
      updated: new Date().toISOString()
    };
  } catch (e) {
    return { error: e.message };
  }
}

async function fetchStockDaily(symbol) {
  const key = getAvKey();
  try {
    const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${symbol}&outputsize=compact&apikey=${key}`;
    const j = await fetchJSON(url);
    
    if (j["Error Message"] || j["Note"]) {
      throw new Error("Rate limited");
    }
    
    const series = j["Time Series (Daily)"];
    if (!series) throw new Error("No data");
    
    const dates = Object.keys(series).slice(0, 5);
    const prices = dates.map(date => parseFloat(series[date]["4. close"]));
    
    // Calculate 52-week range from available data
    const allPrices = Object.values(series).map(d => parseFloat(d["4. close"]));
    const high52w = Math.max(...allPrices);
    const low52w = Math.min(...allPrices);
    
    return {
      sparkline: prices,
      high52w,
      low52w
    };
  } catch (e) {
    return { error: e.message };
  }
}

async function fetchCrypto(id) {
  try {
    const url = `https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=usd&include_24hr_change=true&include_market_cap=true`;
    const j = await fetchJSON(url);
    
    const data = j[id];
    if (!data) throw new Error("No data");
    
    const sparkUrl = `https://api.coingecko.com/api/v3/coins/${id}/market_chart?vs_currency=usd&days=7&interval=daily`;
    const sparkData = await fetchJSON(sparkUrl);
    const prices = sparkData.prices?.slice(-5)?.map(p => p[1]) || [];
    
    return {
      price: data.usd,
      change: data.usd * (data.usd_24h_change / 100),
      pct: data.usd_24h_change,
      sparkline: prices,
      marketCap: data.usd_market_cap,
      updated: new Date().toISOString()
    };
  } catch (e) {
    return { error: e.message };
  }
}

function generateSparkline(prices) {
  if (!prices || prices.length < 2) return '';
  
  const min = Math.min(...prices);
  const max = Math.max(...prices);
  const range = max - min;
  const width = 100;
  const height = 20;
  
  if (range === 0) {
    return `<svg viewBox="0 0 ${width} ${height}"><polyline points="${prices.map((_, i) => `${(i / (prices.length - 1)) * width},${height/2}`).join(' ')}"/></svg>`;
  }
  
  const points = prices.map((price, i) => {
    const x = (i / (prices.length - 1)) * width;
    const y = height - ((price - min) / range) * height;
    return `${x},${y}`;
  }).join(' ');
  
  return `<svg viewBox="0 0 ${width} ${height}"><polyline points="${points}"/></svg>`;
}

function formatPrice(price, prefix = '$') {
  if (price >= 1000000) return prefix + (price / 1000000).toFixed(1) + 'M';
  if (price >= 1000) return prefix + (price / 1000).toFixed(1) + 'K';
  if (price < 1) return prefix + price.toFixed(4);
  return prefix + price.toFixed(2);
}

function formatMarketCap(cap) {
  if (!cap) return 'â€”';
  if (cap >= 1e12) return '$' + (cap / 1e12).toFixed(1) + 'T';
  if (cap >= 1e9) return '$' + (cap / 1e9).toFixed(1) + 'B';
  if (cap >= 1e6) return '$' + (cap / 1e6).toFixed(1) + 'M';
  return '$' + (cap / 1e3).toFixed(1) + 'K';
}

function getCardBackground(pct) {
  if (pct > 0) {
    const intensity = Math.min(pct / 5, 1) * 0.15;
    return `linear-gradient(135deg, rgba(34,197,94,${intensity}), rgba(16,24,35,.65))`;
  } else if (pct < 0) {
    const intensity = Math.min(Math.abs(pct) / 5, 1) * 0.15;
    return `linear-gradient(135deg, rgba(239,68,68,${intensity}), rgba(16,24,35,.65))`;
  }
  return 'rgba(16,24,35,.65)';
}

function createCard(symbol, data, type = 'stock') {
  if (data.error) {
    return `
      <div class="card muted">
        <div class="sym">${symbol}</div>
        <div class="price" style="color: var(--muted)">Error</div>
        <div class="delta"><span class="muted">${data.error}</span></div>
      </div>
    `;
  }
  
  const bgStyle = `background: ${getCardBackground(data.pct)}`;
  const pctColor = data.pct >= 0 ? '#22c55e' : '#ef4444';
  const changePrefix = data.pct >= 0 ? '+' : '';
  
  const sparkline = data.sparkline ? generateSparkline(data.sparkline) : '';
  
  return `
    <div class="card" style="${bgStyle}" data-symbol="${symbol}" data-type="${type}">
      <div class="sym">${symbol}</div>
      <div class="price">${formatPrice(data.price)}</div>
      <div class="delta" style="color: ${pctColor}">
        ${changePrefix}${data.pct?.toFixed(2)}% <span class="muted">(${formatPrice(data.change, data.change >= 0 ? '+$' : '-$', Math.abs(data.change))})</span>
      </div>
      ${sparkline ? `<div class="spark">${sparkline}</div>` : ''}
      <div class="detail" id="detail-${symbol}"></div>
    </div>
  `;
}

function showDetail(symbol, data, type) {
  const detail = document.getElementById(`detail-${symbol}`);
  if (!detail) return;
  
  let content = '';
  
  if (type === 'stock') {
    content = `
      <div class="detail-row"><span>52W High:</span><span>${data.high52w ? formatPrice(data.high52w) : 'â€”'}</span></div>
      <div class="detail-row"><span>52W Low:</span><span>${data.low52w ? formatPrice(data.low52w) : 'â€”'}</span></div>
      <div class="detail-row"><span>Volume:</span><span>${data.volume ? Number(data.volume).toLocaleString() : 'â€”'}</span></div>
      <div class="detail-row"><span>Prev Close:</span><span>${data.prevClose ? formatPrice(data.prevClose) : 'â€”'}</span></div>
    `;
  } else {
    content = `
      <div class="detail-row"><span>Market Cap:</span><span>${formatMarketCap(data.marketCap)}</span></div>
      <div class="detail-row"><span>24h Vol:</span><span>â€”</span></div>
    `;
  }
  
  detail.innerHTML = content;
  detail.classList.add('show');
}

function hideDetail(symbol) {
  const detail = document.getElementById(`detail-${symbol}`);
  if (detail) {
    detail.classList.remove('show');
  }
}

function renderSectors() {
  const container = document.getElementById('sectors');
  container.innerHTML = '';
  
  Object.entries(SECTORS).forEach(([sectorName, symbols]) => {
    const sectorDiv = document.createElement('div');
    sectorDiv.className = 'sector';
    
    const header = document.createElement('div');
    header.className = 'sector-header';
    header.textContent = sectorName;
    
    const grid = document.createElement('div');
    grid.className = 'grid';
    grid.id = `sector-${sectorName.replace(/[^a-zA-Z0-9]/g, '')}`;
    
    sectorDiv.appendChild(header);
    sectorDiv.appendChild(grid);
    container.appendChild(sectorDiv);
    
    // Render cards for this sector
    symbols.forEach(symbol => {
      const isCrypto = CRYPTOS.includes(symbol);
      const data = isCrypto ? state.cryptos[symbol] : state.stocks[symbol];
      if (data) {
        grid.innerHTML += createCard(symbol, data, isCrypto ? 'crypto' : 'stock');
      }
    });
  });
  
  // Add click handlers
  document.querySelectorAll('.card').forEach(card => {
    card.addEventListener('click', (e) => {
      e.stopPropagation();
      const symbol = card.dataset.symbol;
      const type = card.dataset.type;
      
      if (state.expanded === symbol) {
        // Collapse
        card.classList.remove('expanded');
        hideDetail(symbol);
        state.expanded = null;
      } else {
        // Collapse previously expanded
        if (state.expanded) {
          const prevCard = document.querySelector(`[data-symbol="${state.expanded}"]`);
          if (prevCard) {
            prevCard.classList.remove('expanded');
            hideDetail(state.expanded);
          }
        }
        
        // Expand this one
        card.classList.add('expanded');
        const data = type === 'crypto' ? state.cryptos[symbol] : state.stocks[symbol];
        showDetail(symbol, data, type);
        state.expanded = symbol;
      }
    });
  });
  
  // Click outside to collapse
  document.addEventListener('click', (e) => {
    if (state.expanded && !e.target.closest('.card')) {
      const card = document.querySelector(`[data-symbol="${state.expanded}"]`);
      if (card) {
        card.classList.remove('expanded');
        hideDetail(state.expanded);
        state.expanded = null;
      }
    }
  });
}

function updateWidgets() {
  // Fear & Greed
  const fngV = document.getElementById('fngV');
  const fngS = document.getElementById('fngS');
  const fngW = document.getElementById('fngW');
  if (state.widgets.fng.value !== null) {
    fngV.textContent = state.widgets.fng.value;
    fngS.textContent = state.widgets.fng.label;
    if (state.widgets.fng.color) {
      fngW.style.background = state.widgets.fng.color;
    }
  } else {
    fngV.textContent = 'â€”';
    fngS.textContent = state.widgets.fng.label || 'Error';
  }
  
  // Gold & Silver
  ['gold', 'silver'].forEach(metal => {
    const data = state.widgets[metal];
    const vEl = document.getElementById(`${metal}V`);
    const sEl = document.getElementById(`${metal}S`);
    const wEl = document.getElementById(`${metal}W`);
    
    if (data.price) {
      vEl.textContent = formatPrice(data.price);
      const pctColor = data.pct >= 0 ? '#22c55e' : '#ef4444';
      const prefix = data.pct >= 0 ? '+' : '';
      sEl.innerHTML = `<span style="color: ${pctColor}">${prefix}${data.pct.toFixed(2)}%</span>`;
      wEl.style.background = getCardBackground(data.pct);
    } else if (data.error) {
      vEl.textContent = 'â€”';
      sEl.textContent = data.error;
    }
  });
}

function updateSummary() {
  const allData = [...Object.values(state.stocks), ...Object.values(state.cryptos)];
  const validData = allData.filter(d => d.price && !d.error);
  
  if (validData.length === 0) return;
  
  const positive = validData.filter(d => d.pct > 0).length;
  const negative = validData.filter(d => d.pct < 0).length;
  const neutral = validData.length - positive - negative;
  
  let mood = 'ðŸ“Š Mixed';
  if (positive > negative * 1.5) mood = 'ðŸŸ¢ Bullish';
  else if (negative > positive * 1.5) mood = 'ðŸ”´ Bearish';
  
  document.getElementById('mood').textContent = mood;
  document.getElementById('counts').textContent = `${positive}â†— ${negative}â†˜ ${neutral}â†’`;
  
  const sortedByPct = [...validData].sort((a, b) => b.pct - a.pct);
  const best = sortedByPct[0];
  const worst = sortedByPct[sortedByPct.length - 1];
  
  document.getElementById('best').textContent = best ? `${getSymbolForData(best)} +${best.pct.toFixed(2)}%` : 'â€”';
  document.getElementById('worst').textContent = worst ? `${getSymbolForData(worst)} ${worst.pct.toFixed(2)}%` : 'â€”';
}

function getSymbolForData(data) {
  // Find symbol by reference
  for (const [symbol, stockData] of Object.entries(state.stocks)) {
    if (stockData === data) return symbol;
  }
  for (const [symbol, cryptoData] of Object.entries(state.cryptos)) {
    if (cryptoData === data) return symbol;
  }
  return 'â€”';
}

async function loadStockQuotes() {
  setStatus('Loading quotes...', 'warn');
  const batchSize = 5;
  let completed = 0;
  
  for (let i = 0; i < ALL_STOCKS.length; i += batchSize) {
    const batch = ALL_STOCKS.slice(i, i + batchSize);
    
    await Promise.all(batch.map(async (symbol) => {
      const data = await fetchStock(symbol);
      state.stocks[symbol] = data;
      completed++;
      updateProgress(`Quotes: ${completed}/${ALL_STOCKS.length}`, completed, ALL_STOCKS.length);
    }));
    
    if (i + batchSize < ALL_STOCKS.length) {
      await sleep(12000); // 12s between batches (5 calls per minute limit)
    }
  }
}

async function loadStockSparklines() {
  setStatus('Loading sparklines...', 'warn');
  const batchSize = 5;
  let completed = 0;
  
  for (let i = 0; i < ALL_STOCKS.length; i += batchSize) {
    const batch = ALL_STOCKS.slice(i, i + batchSize);
    
    await Promise.all(batch.map(async (symbol) => {
      const data = await fetchStockDaily(symbol);
      if (state.stocks[symbol] && !data.error) {
        state.stocks[symbol].sparkline = data.sparkline;
        state.stocks[symbol].high52w = data.high52w;
        state.stocks[symbol].low52w = data.low52w;
      }
      completed++;
      updateProgress(`Sparklines: ${completed}/${ALL_STOCKS.length}`, completed, ALL_STOCKS.length);
    }));
    
    renderSectors(); // Re-render with new sparklines
    
    if (i + batchSize < ALL_STOCKS.length) {
      await sleep(12000); // 12s between batches
    }
  }
}

async function loadCryptos() {
  const cryptoIds = { BTC: 'bitcoin', ETH: 'ethereum', SOL: 'solana' };
  
  for (const [symbol, id] of Object.entries(cryptoIds)) {
    const data = await fetchCrypto(id);
    state.cryptos[symbol] = data;
  }
}

async function loadWidgets() {
  await Promise.all([
    fetchFNG(),
    fetchMetal('XAU', 'USD').then(data => state.widgets.gold = data),
    fetchMetal('XAG', 'USD').then(data => state.widgets.silver = data)
  ]);
}

async function refresh() {
  setStatus('Loading...', 'warn');
  updateProgress('Starting...', 0, 1);
  
  try {
    // Load widgets and cryptos (no rate limit)
    await Promise.all([loadWidgets(), loadCryptos()]);
    updateWidgets();
    
    // Load stock quotes (rate limited)
    await loadStockQuotes();
    renderSectors();
    updateSummary();
    
    // Load sparklines (rate limited)
    await loadStockSparklines();
    
    setStatus('Complete', 'ok');
    document.getElementById('last').textContent = new Date().toLocaleTimeString();
    
  } catch (error) {
    console.error(error);
    setStatus('Error', 'bad');
  }
  
  updateProgress('', 0, 0);
}

function copySnapshot() {
  const allData = [...Object.entries(state.stocks), ...Object.entries(state.cryptos)];
  const validData = allData.filter(([_, data]) => data.price && !data.error);
  
  let text = `Portfolio Pulse Snapshot - ${new Date().toLocaleString()}\n\n`;
  
  // Add summary
  const positive = validData.filter(([_, d]) => d.pct > 0).length;
  const negative = validData.filter(([_, d]) => d.pct < 0).length;
  text += `Market mood: ${positive}â†— ${negative}â†˜ ${validData.length - positive - negative}â†’\n\n`;
  
  // Add by sectors
  Object.entries(SECTORS).forEach(([sectorName, symbols]) => {
    const sectorData = symbols.map(s => [s, state.stocks[s] || state.cryptos[s]])
                            .filter(([_, d]) => d && d.price && !d.error);
    
    if (sectorData.length > 0) {
      text += `${sectorName}:\n`;
      sectorData.forEach(([symbol, data]) => {
        const prefix = data.pct >= 0 ? '+' : '';
        text += `  ${symbol}: ${formatPrice(data.price)} (${prefix}${data.pct.toFixed(2)}%)\n`;
      });
      text += '\n';
    }
  });
  
  // Add widgets
  if (state.widgets.fng.value !== null) {
    text += `Fear & Greed: ${state.widgets.fng.value} (${state.widgets.fng.label})\n`;
  }
  if (state.widgets.gold.price) {
    text += `Gold: ${formatPrice(state.widgets.gold.price)} (${state.widgets.gold.pct >= 0 ? '+' : ''}${state.widgets.gold.pct.toFixed(2)}%)\n`;
  }
  if (state.widgets.silver.price) {
    text += `Silver: ${formatPrice(state.widgets.silver.price)} (${state.widgets.silver.pct >= 0 ? '+' : ''}${state.widgets.silver.pct.toFixed(2)}%)\n`;
  }
  
  navigator.clipboard.writeText(text);
  setStatus('Copied!', 'ok');
  setTimeout(() => setStatus('Complete', 'ok'), 1500);
}

// Event listeners
document.getElementById('refresh').addEventListener('click', refresh);
document.getElementById('copy').addEventListener('click', copySnapshot);

document.addEventListener('keydown', (e) => {
  if (e.key === 'r' || e.key === 'R') {
    e.preventDefault();
    refresh();
  } else if (e.key === 'c' || e.key === 'C') {
    e.preventDefault();
    copySnapshot();
  }
});

// Auto-refresh
let autoInterval = null;
document.getElementById('auto').addEventListener('change', (e) => {
  if (e.target.checked) {
    autoInterval = setInterval(refresh, 5 * 60 * 1000);
  } else if (autoInterval) {
    clearInterval(autoInterval);
    autoInterval = null;
  }
});

// Update time display
function updateTime() {
  document.getElementById('now').textContent = new Date().toLocaleString();
}
updateTime();
setInterval(updateTime, 1000);

// Initial load
refresh();
</script>
</body>
</html>